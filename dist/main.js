!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);class i{constructor(e=0,t=0,s=32,i,n){this.x=e,this.y=t,this.length=s,this.depth=i,this.sprite=null,this.shape=null,this.mouseover=!1,this.selected=!1,this.game=n,this.selectable=!0,this.interface=""}update(){this.sprite&&this.sprite.update()}onMouseOver(){}onMouseLeave(){}onMouseClick(){}getInterface(){}}class n{constructor(e,t,s,i,n){let r=this;this.canvas=e,this.ctx=t,this.canvasW=s,this.canvasH=i,this.mouse={x:0,y:0},this.gameObjectStorage=[];for(let e=0;e<=3;e++)this.gameObjectStorage[e]=new Set;this.storageHoles=[],this.selectedGameobject=null,this.gui=n,document.onmousemove=this.updateMousePosition.bind(this),document.onclick=function(){r.selectGameObject.call(r),r.gameObjectInterfaceUpdate.call(r)};let o=this.update.bind(this);return setInterval(o,20),this.methods={createGameObject:r.createGameObject.bind(r),removeGameObject:r.removeGameObject.bind(r),logMessage:r.gui.logMessage.bind(r.gui)},this.methods}createGameObject(e,t,s,i,n=3){let r=new e(t,s,i,n,this.methods);return this.gameObjectStorage[n].add(r),r}removeGameObject(e){this.gameObjectStorage[e.depth].delete(e)}update(){for(let e=0;e<this.gameObjectStorage.length;e++)for(let t of this.gameObjectStorage[e])t.update();this.render()}updateMousePosition(e){this.mouse.x=e.clientX-this.canvas.getBoundingClientRect().x,this.mouse.y=e.clientY-this.canvas.getBoundingClientRect().y,this.isMouseOverGameObject()}isMouseOverGameObject(){let e=this.mouse.x,t=this.mouse.y;this.gameObjectStorage.forEach((function(s){for(let i of s)if(i){let s=e-i.x<i.length&&e-i.x>0,n=t-i.y<i.length&&t-i.y>0;s&&n?(i.onMouseOver(),i.mouseover=!0):(i.onMouseLeave(),i.mouseover=!1)}}))}selectGameObject(){let e=!1,t=null;for(let s=0;s<this.gameObjectStorage.length;s++)for(let i of this.gameObjectStorage[s])i&&i.selectable&&(i.selected&&(t=i),e?i.selected=!1:i.mouseover?(i.selected=!0,this.selectedGameobject=i,e=!0):i.selected=!1);!e&&t&&(t.selected=!0)}gameObjectInterfaceUpdate(){this.gui.drawGameObjectInterface(this.selectedGameobject)}render(){this.ctx.clearRect(0,0,this.canvasW,this.canvasH);for(let e=this.gameObjectStorage.length-1;e>=0;e--)for(let t of this.gameObjectStorage[e])t&&(t.sprite&&this.ctx.drawImage(t.sprite.img,t.length*t.sprite.imageIndex,0,t.length,t.length,t.x,t.y,t.length,t.length),t.shape&&(this.ctx.fillStyle=t.shape.color,this.ctx.fillRect(t.x+t.shape.x,t.y+t.shape.y,t.shape.w,t.shape.h)))}}class r{constructor(e){this.img=e,this.imageIndex=0,this.frames=0,this.counter=0,this.maxCounter=0}update(){this.frames>1&&(this.counter++,this.counter>=this.maxCounter&&(this.imageIndex+=1,this.counter=0),this.imageIndex===this.frames&&(this.imageIndex=0))}}class o extends i{constructor(e,t,s,i,n){super(e,t,s,i,n),this.selectable=!1,this.name="name",this.cost=0,this.resource="resource",this.resourceAmount=1,this.isFeed=!0,this.isGrew=!1,this.food="Пшеница",this.foodAmount=0,this.growTime=0,this.growCounter=0}static getEntityCost(){return 0}reset(){this.isGrow=!1,this.growCounter=0,this.shape=null}update(){super.update(),!this.isGrow&&this.isFeed&&(this.growCounter++,this.shape={x:4,y:this.length-8,w:(this.length-8)*(this.growCounter/this.growTime),h:8,color:"red"},this.growCounter===this.growTime&&(this.isGrow=!0,this.growCompleted()))}growCompleted(){this.shape.color="green"}}class a extends o{constructor(e=0,t=0,s=32,i,n){super(e,t,s,i,n),this.name="Пшеничное поле",this.resource="Пшеница",this.growTime=300,this.sprite=new r(document.getElementById("spr-wheat")),this.sprite.frames=0}static getEntityCost(){return 0}reset(){super.reset(),this.sprite.imageIndex=0}update(){super.update();let e=this.growCounter/this.growTime;e>.99?this.sprite.imageIndex=3:e>.66?this.sprite.imageIndex=2:e>.3&&(this.sprite.imageIndex=1)}}class h extends o{constructor(e=0,t=0,s=32,i,n){super(e,t,s,i,n),this.name="Курица",this.resource="Яйца",Math.random()>.3?(this.sprite=new r(document.getElementById("spr-chicken-0")),this.sprite.frames=2):(this.sprite=new r(document.getElementById("spr-chicken-1")),this.sprite.frames=7),this.sprite.maxCounter=20+20*Math.random(),this.growTime=600,this.isFeed=!1,this.foodAmount=1}static getEntityCost(){return 10}reset(){super.reset(),this.isFeed=!1}update(){super.update()}growCompleted(){super.growCompleted(),console.log("Chicken grew")}}class c extends o{constructor(e=0,t=0,s=32,i,n){super(e,t,s,i,n),this.name="Корова",this.resource="Молоко",this.resourceAmount=4,this.sprite=new r(document.getElementById("spr-cow")),this.sprite.frames=2,this.sprite.maxCounter=20+20*Math.random(),this.growTime=600,this.isFeed=!1,this.foodAmount=2}static getEntityCost(){return 40}reset(){super.reset(),this.isFeed=!1}update(){super.update()}growCompleted(){super.growCompleted(),console.log("Cow grew")}}class u extends i{constructor(e,t,s,i,n){super(e,t,s,i,n),this.sprite=new r(document.getElementById("spr-grass")),this.sprite.frames=2,this.sprite.maxCounter=30+30*Math.random(),this.entity=null,this.type="tile",this.barn=null}onMouseOver(){this.shape={x:0,y:0,w:this.length,h:this.length,color:"rgba(255,255,255,0.3)"}}onMouseLeave(){this.shape=null}update(){super.update(),this.selected?this.shape={x:0,y:0,w:this.length,h:this.length,color:"rgba(255,255,255,0.2)"}:this.shape=null}placeEntity(e){let t=e.getEntityCost();this.entity||(this.barn.removeItem("Золото",t)?(this.entity=this.game.createGameObject(e,this.x,this.y-12,50,0),this.entity.cost=t,this.game.logMessage(`Вы построили ${this.entity.name}`)):this.game.logMessage("Недостаточно денег для постройки"))}feedEntity(){this.entity&&(this.entity.isFeed||(this.barn.removeItem(this.entity.food,this.entity.foodAmount)?(this.entity.isFeed=!0,this.game.logMessage(`Вы покормили ${this.entity.name} \n                                                     (-${this.entity.foodAmount} \n                                                       ${this.entity.food})`)):this.game.logMessage(`Слишком мало ${this.entity.food} чтобы\n                                          покормить ${this.entity.name}`)))}removeEntity(){if(this.entity){let e=Math.floor(this.entity.cost/2);this.barn.addItem("Золото",e)?(this.game.logMessage(`Вы избавились от ${this.entity.name} за +${e}`),this.game.removeGameObject(this.entity),this.entity=null):this.game.logMessage("Недотаточно места на складе")}}getResource(){this.entity&&(this.entity.isGrow?this.barn.addItem(this.entity.resource,this.entity.resourceAmount)?(this.entity.reset(),this.game.logMessage(`Вы собрали ${this.entity.resource} \n                                                    +${this.entity.resourceAmount}`)):this.game.logMessage("Склад заполнен, невозможно забрать ресурсы"):this.game.logMessage(`${this.entity.name} еще не произвело ${this.entity.resource}`))}makeInterface(e){let t=this,s=[];return s.push({type:"div",className:"text-gui",text:`Здесь живет ${e.name}`}),s.push({type:"button",text:`Собрать ресурс ${this.entity.resource} (+ ${this.entity.resourceAmount} ${this.entity.resource})`,handler:t.getResource.bind(t)}),e.foodAmount>0&&s.push({type:"button",text:`Покормить ${this.entity.name} (- ${this.entity.foodAmount} ${this.entity.food})`,handler:t.feedEntity.bind(t)}),s.push({type:"button",text:`Продать ${this.entity.name} (+ ${Math.floor(this.entity.cost/2)} Золото)`,handler:t.removeEntity.bind(t)}),s}getInterface(){let e=this;return this.entity?this.makeInterface(this.entity):[{type:"div",className:"text-gui",text:"Здесь можно что-то построить"},{type:"button",text:`Посадить пшеницу (-${a.getEntityCost()} Золото)`,handler:e.placeEntity.bind(e,a)},{type:"button",text:`Завести курицу (-${h.getEntityCost()} Золото)`,handler:e.placeEntity.bind(e,h)},{type:"button",text:`Завести корову (-${c.getEntityCost()} Золото)`,handler:e.placeEntity.bind(e,c)}]}}class l{constructor(e=document.body,t){this.gameObjectInterfaceContainer=e,this.messageContainer=t,this.drawGameObjectInterface(),this.timer=setTimeout(0)}drawGameObjectInterface(e){if(this.gameObjectInterfaceContainer.innerHTML="",e){let t=this.gameObjectInterfaceParse(e.getInterface());if(t)for(let e=0;e<t.length;e++)this.gameObjectInterfaceContainer.appendChild(t[e]);else this.gameObjectInterfaceContainer.innerHTML="Ребят, ну вы тут интерфейс проебали"}else this.gameObjectInterfaceContainer.innerHTML="Выберите клетку чтобы посадить ресурс"}gameObjectInterfaceParse(e){if(e){let t=[];for(let s=0;s<e.length;s++){let i=document.createElement(e[s].type);if(i.innerHTML=e[s].text,e[s].hasOwnProperty("className")&&(i.className=e[s].className),"button"===e[s].type&&(i.onclick=function(){e[s].handler()}),e[s].hasOwnProperty("childNodes")){let t=this.gameObjectInterfaceParse(e[s].childNodes);for(let e=0;e<t.length;e++)i.appendChild(t[e])}t.push(i)}return t}return 0}logMessage(e){let t=this;clearTimeout(this.timer),this.messageContainer.innerHTML=e,this.timer=setTimeout((function(){t.messageContainer.innerHTML=""}),4e3)}}class m extends i{constructor(e,t,s,i,n){super(e,t,s,i,n),this.storage={},this.sprite=new r(document.getElementById("spr-barn"))}addResource(e,t,s,i,n){return this.storage.hasOwnProperty(e)||(this.storage[e]={name:e,quantity:t,maxQuantity:s,tradable:i,cost:n}),this.storage[e]}addItem(e,t=1){let s=this.storage[e];return s.quantity+t<=s.maxQuantity&&(s.quantity+=t,!0)}removeItem(e,t=1){let s=this.storage[e];return s.quantity-t>=0&&(s.quantity-=t,!0)}sellItem(e,t){this.removeItem(e)?this.addItem("Золото",t)?this.game.logMessage(`Вы продали ${e} за ${t} золота`):(this.addItem(e),this.game.logMessage("Недостаточно места на складе для золота")):this.game.logMessage("Недостаточно ресурсов для продажи")}makeInterface(e){let t=[],s=this;t.push({type:"div",text:"Амбар:"});for(let i in e){let n={type:"div",text:"",className:"table-row",childNodes:[{type:"div",className:"text-gui",text:`${i}: \n                               ${s.storage[i].quantity}/\n                               ${s.storage[i].maxQuantity}`}]};this.storage[i].tradable&&n.childNodes.push({type:"button",text:`Продать ${i}`,handler:s.sellItem.bind(s,i,e[i].cost)}),t.push(n)}return t}getInterface(){return this.makeInterface(this.storage)}}window.onload=function(){let e=document.getElementById("main-canvas"),t=e.getContext("2d"),s=new l(document.getElementById("gameObject-gui"),document.getElementById("message-gui")),i=new n(e,t,650,500,s),r=i.createGameObject(m,500,50,100,0);r.addResource("Пшеница",0,25,!0,2),r.addResource("Молоко",0,25,!0,10),r.addResource("Яйца",0,25,!0,5),r.addResource("Золото",100,100,!1);for(let e=1;e<=8;e++)for(let t=1;t<=8;t++){i.createGameObject(u,50*e,50*t,50,3).barn=r}}}]);